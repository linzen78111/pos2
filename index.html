<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>GèŒ¶é¤é…’é¤¨ é»é¤ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; margin: 0; background: #2d2320; }
    .container { max-width: 400px; margin: 0 auto; padding: 16px; background: #3e2f28; border-radius: 16px; box-shadow: 0 2px 16px #0005; color: #f5e9da; }
    .brand { font-size: 2em; font-weight: bold; text-align: center; margin: 18px 0 10px 0; letter-spacing: 2px; color: #e0b873; text-shadow: 0 2px 8px #0006; }
    h2 { margin-top: 0; color: #e0b873; }
    .dine-type-group { display: flex; justify-content: center; gap: 24px; margin-bottom: 16px; }
    .dine-type-group label { font-size: 1.1em; cursor: pointer; }
    .category-block { margin-bottom: 18px; border-radius: 8px; background: #4a362a; box-shadow: 0 1px 4px #0002; }
    .category-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; padding: 12px 16px; font-size: 1.15em; font-weight: bold; border-radius: 8px 8px 0 0; background: #4a362a; color: #e0b873; border-bottom: 1px solid #e0b87333; }
    .category-header:hover { background: #6b4c36; }
    .category-arrow { font-size: 1.2em; transition: transform 0.2s; }
    .category-arrow.open { transform: rotate(90deg); }
    .category-content { padding: 0 12px 10px 12px; }
    .menu-item { display: flex; align-items: flex-start; justify-content: space-between; margin: 16px 0; border-bottom: 1px solid #e0b87333; padding-bottom: 10px; }
    .menu-item:last-child { border-bottom: none; }
    .menu-item span { display: flex; align-items: flex-start; }
    .menu-item img { width: 48px; height: 48px; object-fit: cover; border-radius: 8px; margin-right: 12px; border: 2px solid #e0b87355; background: #fff; }
    .menu-item .info { display: flex; flex-direction: column; }
    .menu-item .price { color: #e0b873; font-size: 0.98em; margin-top: 2px; font-weight: bold; }
    .menu-item .note { color: #f5e9da; font-size: 0.97em; margin-top: 4px; white-space: pre-line; opacity: 0.85; }
    .menu-item input[type=number] { width: 60px; font-size: 1.1em; margin-left: 8px; background: #2d2320; color: #e0b873; border: 1.5px solid #e0b873; border-radius: 6px; padding: 4px; }
    button { width: 100%; padding: 14px; font-size: 1.2em; background: #e0b873; color: #2d2320; border: none; border-radius: 10px; margin-top: 20px; font-weight: bold; letter-spacing: 2px; box-shadow: 0 2px 8px #0002; transition: background 0.2s, color 0.2s; }
    button:disabled { background: #bfa05a; color: #fff; }
    .loading { text-align: center; color: #e0b873; margin: 16px 0; }
    .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #4a362a; color: #e0b873; padding: 12px 24px; border-radius: 24px; opacity: 0.97; z-index: 999; font-weight: bold; border: 2px solid #e0b873; box-shadow: 0 2px 8px #0003; }
    .dine-type-modern { display: flex; justify-content: center; gap: 18px; margin-bottom: 16px; }
    .dine-btn { flex: 1; padding: 14px 0; font-size: 1.1em; border: 2px solid #e0b873; background: #2d2320; color: #e0b873; border-radius: 8px; cursor: pointer; transition: background 0.2s, color 0.2s, border 0.2s; font-weight: bold; }
    .dine-btn.selected, .dine-btn:active { background: #e0b873; color: #2d2320; border: 2px solid #e0b873; }
    input::placeholder { color: #e0b87399; }
    .table-section { margin-bottom: 16px; }
    .table-section h2 { margin-bottom: 8px; }
    .table-section input { width: 100%; font-size: 1.1em; padding: 8px; border: 1.5px solid #e0b873; border-radius: 6px; background: #2d2320; color: #e0b873; }
    .hidden { display: none !important; }
    
    /* Modal æ¨£å¼ */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); }
    .modal-content { background-color: #3e2f28; margin: 2% auto; padding: 16px; border-radius: 12px; width: 92%; max-width: 450px; max-height: 96vh; overflow-y: auto; color: #f5e9da; border: 2px solid #e0b873; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .modal-title { font-size: 1.2em; font-weight: bold; color: #e0b873; }
    .close { color: #e0b873; font-size: 26px; font-weight: bold; cursor: pointer; line-height: 1; }
    .close:hover { color: #fff; }
    .order-summary { margin-bottom: 16px; }
    .order-summary p { margin: 6px 0; font-size: 0.95em; }
    .order-table { width: 100%; border-collapse: collapse; margin-bottom: 12px; font-size: 0.85em; }
    .order-table th, .order-table td { padding: 4px 2px; text-align: left; border-bottom: 1px solid #e0b87333; }
    .order-table th { background-color: #4a362a; font-weight: bold; color: #e0b873; }
    .order-table td { color: #f5e9da; }
    .order-table th:nth-child(2), .order-table td:nth-child(2) { text-align: center; width: 15%; }
    .order-table th:nth-child(3), .order-table td:nth-child(3) { text-align: right; width: 20%; }
    .order-table th:nth-child(4), .order-table td:nth-child(4) { text-align: right; width: 20%; }
    .total-amount { font-size: 1.1em; font-weight: bold; color: #e0b873; text-align: right; margin-bottom: 16px; }
    .modal-buttons { display: flex; gap: 8px; }
    .modal-btn { flex: 1; padding: 10px; font-size: 1em; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
    .btn-cancel { background: #666; color: #fff; }
    .btn-confirm { background: #e0b873; color: #2d2320; }
    .btn-cancel:hover { background: #555; }
    .btn-confirm:hover { background: #d4a862; }
    
    /* ç†±éŠ·æ¨™ç±¤ */
    .hot-badge { background: #e74c3c; color: #fff; font-size: 0.8em; padding: 2px 6px; border-radius: 10px; margin-left: 8px; }
    
    /* åœ–ç‰‡æ”¾å¤§modal */
    .image-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
    .image-modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90%; max-height: 90%; }
    .image-modal img { width: 100%; height: auto; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    .image-modal-close { position: absolute; top: 15px; right: 25px; color: #fff; font-size: 35px; font-weight: bold; cursor: pointer; z-index: 2001; }
    .image-modal-close:hover { color: #e0b873; }
    .clickable-image { cursor: pointer; transition: transform 0.2s; }
    .clickable-image:hover { transform: scale(1.05); }
    
    @media (max-width: 500px) {
      .container { max-width: 98vw; }
      .menu-item img { width: 40px; height: 40px; }
      .brand { font-size: 1.4em; }
      .modal-content { margin: 1% auto; width: 96%; padding: 12px; max-height: 98vh; }
      .modal-title { font-size: 1.1em; }
      .close { font-size: 22px; }
      .order-summary p { font-size: 0.9em; margin: 4px 0; }
      .order-table { font-size: 0.8em; }
      .order-table th, .order-table td { padding: 3px 1px; }
      .total-amount { font-size: 1em; }
      .modal-btn { padding: 8px; font-size: 0.95em; }
      .image-modal-close { top: 10px; right: 15px; font-size: 30px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="brand">GèŒ¶é¤é…’é¤¨</div>
    <div class="dine-type-modern">
      <button type="button" id="dineInBtn" class="dine-btn selected" onclick="selectDineType('å…§ç”¨')">å…§ç”¨</button>
      <button type="button" id="takeOutBtn" class="dine-btn" onclick="selectDineType('å¤–å¸¶')">å¤–å¸¶</button>
      <input type="hidden" id="dineType" value="å…§ç”¨">
    </div>
    
    <div class="table-section" id="tableSection">
      <h2>è¼¸å…¥æ¡Œè™Ÿ</h2>
      <input type="text" id="tableNumber" placeholder="ä¾‹å¦‚ A2" />
    </div>

    <h2>é¸æ“‡é¤é»</h2>
    <div id="menuList">
      <div class="loading">è¼‰å…¥èœå–®ä¸­...</div>
    </div>

    <button id="submitBtn" onclick="submitOrder()">é€å‡ºè¨‚å–®</button>
  </div>
  
  <!-- è¨‚å–®ç¢ºèª Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ç¢ºèªè¨‚å–®</div>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      <div class="order-summary">
        <div id="orderDetails"></div>
        <div class="total-amount" id="totalAmount"></div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="modal-btn btn-confirm" onclick="confirmOrder()">ç¢ºèªé€å‡º</button>
      </div>
    </div>
  </div>
  
  <!-- åœ–ç‰‡æ”¾å¤§ Modal -->
  <div id="imageModal" class="image-modal">
    <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
    <div class="image-modal-content">
      <img id="modalImage" src="" alt="">
    </div>
  </div>
  
  <div id="toast" class="toast" style="display:none"></div>

  <!-- è¼‰å…¥é…ç½®æ–‡ä»¶ -->
  <script src="config.js"></script>
  
  <script>
    // API é…ç½®ï¼ˆå¾ config.js å‹•æ…‹è¼‰å…¥ï¼‰
    const API_BASE_URL = window.APP_CONFIG.API_BASE_URL;

    let menu = [];
    let menuPrices = {};
    let menuOrderLimits = {};
    let currentOrderData = null;

    // å–å¾— query string çš„æ¡Œè™Ÿ
    function getTableNumberFromQuery() {
      const params = new URLSearchParams(window.location.search);
      return params.get('table') || '';
    }

    // é¡¯ç¤º Toast
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.innerText = msg;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 2000);
    }

    // API èª¿ç”¨å‡½æ•¸
    async function apiRequest(endpoint, options = {}) {
      try {
        const response = await fetch(`${API_BASE_URL}${endpoint}`, {
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          },
          ...options
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error(`API èª¿ç”¨å¤±æ•— (${endpoint}):`, error);
        throw error;
      }
    }

    // æª¢æŸ¥é»é¤é™åˆ¶
    function checkOrderLimit(inputElement, itemName, orderLimit) {
      if (orderLimit <= 0) return; // ç„¡é™åˆ¶
      
      const currentValue = parseInt(inputElement.value) || 0;
      
      // æª¢æŸ¥è©²å“é …åœ¨å…¶ä»–åœ°æ–¹çš„æ•¸é‡ï¼ˆç†±éŠ·å€å¡Šå’Œä¸€èˆ¬åˆ†é¡å¯èƒ½é‡è¤‡ï¼‰
      const itemId = inputElement.id.replace(/^(hot_)?item_/, '');
      const normalInput = document.getElementById('item_' + itemId);
      const hotInput = document.getElementById('hot_item_' + itemId);
      
      let totalQuantity = 0;
      if (normalInput) totalQuantity += parseInt(normalInput.value) || 0;
      if (hotInput) totalQuantity += parseInt(hotInput.value) || 0;
      
      if (totalQuantity > orderLimit) {
        // è¨ˆç®—éœ€è¦èª¿æ•´çš„æ•¸é‡
        const otherInput = inputElement.id.includes('hot_item_') ? normalInput : hotInput;
        const otherValue = otherInput ? (parseInt(otherInput.value) || 0) : 0;
        const maxAllowed = Math.max(0, orderLimit - otherValue);
        
        // èª¿æ•´ç•¶å‰è¼¸å…¥æ¡†çš„å€¼
        inputElement.value = maxAllowed;
        showToast(`${itemName} æ¯äººé™é» ${orderLimit} ä»½ï¼Œå·²è‡ªå‹•èª¿æ•´`);
      }
    }

    // ç”Ÿæˆè¨‚å–®ç·¨è™Ÿ
    async function generateOrderId(dineType) {
      const now = new Date();
      const dateStr = now.getFullYear().toString() + 
                     (now.getMonth() + 1).toString().padStart(2, '0') + 
                     now.getDate().toString().padStart(2, '0');
      const typeCode = dineType === 'å…§ç”¨' ? 'D' : 'T';
      
      // å–å¾—ä»Šæ—¥å·²ä½¿ç”¨çš„åºè™Ÿ
      const usedNumbers = await getTodayUsedNumbers(dineType, dateStr);
      
      // æ‰¾åˆ°ä¸‹ä¸€å€‹å¯ç”¨çš„åºè™Ÿ (001-999)
      let number = 1;
      while (usedNumbers.includes(number) && number <= 999) {
        number++;
      }
      
      if (number > 999) {
        throw new Error('ä»Šæ—¥è¨‚å–®åºè™Ÿå·²æ»¿');
      }
      
      const numberStr = number.toString().padStart(3, '0');
      return `${dateStr}-${typeCode}${numberStr}`;
    }

    // å–å¾—ä»Šæ—¥å·²ä½¿ç”¨çš„è¨‚å–®åºè™Ÿ
    async function getTodayUsedNumbers(dineType, dateStr) {
      try {
        const data = await apiRequest(`/used-order-numbers?dineType=${encodeURIComponent(dineType)}&dateStr=${dateStr}`);
        return data;
      } catch (e) {
        console.log("è¼‰å…¥å·²ä½¿ç”¨åºè™Ÿå¤±æ•—:", e);
        return [];
      }
    }

    // å–å¾—æœ¬é€±ç†±éŠ·TOP10å•†å“
    async function getHotItems() {
      try {
        const hotItems = await apiRequest('/hot-items');
        console.log('ğŸ“Š æœ¬é€±ç†±éŠ·TOP10:', hotItems);
        return hotItems;
      } catch (e) {
        console.log("å–å¾—æœ¬é€±ç†±éŠ·å•†å“å¤±æ•—:", e);
        return [];
      }
    }

    // è¼‰å…¥èœå–®ä¸¦ä¾åˆ†é¡åˆ†çµ„
    async function loadMenu() {
      const menuList = document.getElementById('menuList');
      menuList.innerHTML = '<div class="loading">è¼‰å…¥èœå–®ä¸­...</div>';
      menu = [];
      menuPrices = {};
      menuOrderLimits = {};
      
      try {
        const [menuData, hotItems] = await Promise.all([
          apiRequest('/menu'),
          getHotItems()
        ]);
        
        menuList.innerHTML = '';
        
        // ä¾ category åˆ†çµ„
        const categories = {};
        menuData.forEach(data => {
          const orderLimit = data.orderLimit || 0;
          
          menu.push({ name: data.name, id: data.id });
          menuPrices[data.name] = data.price || 0;
          menuOrderLimits[data.name] = orderLimit;
          
          const cat = data.category || 'æœªåˆ†é¡';
          if (!categories[cat]) categories[cat] = [];
          categories[cat].push({ 
            ...data, 
            isHot: hotItems.includes(data.name),
            orderLimit: orderLimit
          });
        });

        // ç†±éŠ·TOP10å€å¡Š
        if (hotItems.length > 0) {
          const hotBlock = document.createElement('div');
          hotBlock.className = 'category-block';
          const hotHeader = document.createElement('div');
          hotHeader.className = 'category-header';
          hotHeader.style.background = '#e74c3c';
          hotHeader.innerHTML = `<span>ğŸ”¥ æœ¬é€±ç†±éŠ·TOP10</span><span class="category-arrow">â–¶</span>`;
          hotBlock.appendChild(hotHeader);
          
          const hotContent = document.createElement('div');
          hotContent.className = 'category-content';
          hotContent.style.display = 'none';
          
          hotItems.forEach(itemName => {
            const itemData = Object.values(categories).flat().find(item => item.name === itemName);
            if (itemData) {
              const limitInfo = itemData.orderLimit > 0 ? 
                              `<span style="color:#f39c12;font-size:0.9em;margin-left:8px;">é™é» ${itemData.orderLimit} ä»½</span>` : '';
              
              const div = document.createElement('div');
              div.className = 'menu-item';
              
              div.innerHTML = `
                <span>
                  ${itemData.image ? 
                    `<img src="${itemData.image}" alt="${itemData.name}" class="clickable-image" onclick="openImageModal('${itemData.image}', '${itemData.name}')" onerror="this.outerHTML='<div style=&quot;width:48px;height:48px;background:#e0b873;color:#2d2320;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;margin-right:12px;border:2px solid #e0b87355;&quot;>ğŸ½ï¸</div>';" />` : 
                    `<div style="width:48px;height:48px;background:#e0b873;color:#2d2320;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;margin-right:12px;border:2px solid #e0b87355;">ğŸ½ï¸</div>`
                  }
                  <span class="info">
                    <div>${itemData.name}<span class="hot-badge">HOT</span>${limitInfo}</div>
                    <div class="price">$${itemData.price || ''}</div>
                    <div class="note">${itemData.note ? itemData.note : ''}</div>
                  </span>
                </span>
                <input type="number" id="hot_item_${itemData.id}" min="0" value="0" max="${itemData.orderLimit > 0 ? itemData.orderLimit : ''}" oninput="checkOrderLimit(this, '${itemData.name}', ${itemData.orderLimit})" onchange="checkOrderLimit(this, '${itemData.name}', ${itemData.orderLimit})" />
              `;
              hotContent.appendChild(div);
            }
          });
          
          hotBlock.appendChild(hotContent);
          hotHeader.onclick = function() {
            const isOpen = hotContent.style.display === 'block';
            hotContent.style.display = isOpen ? 'none' : 'block';
            hotHeader.querySelector('.category-arrow').classList.toggle('open', !isOpen);
          };
          menuList.appendChild(hotBlock);
        }

        // ç”¢ç”Ÿåˆ†é¡å€å¡Šï¼ˆé è¨­å…¨éƒ¨æ”¶åˆï¼‰
        Object.keys(categories).forEach((cat, idx) => {
          const block = document.createElement('div');
          block.className = 'category-block';
          // åˆ†é¡æ¨™é¡Œ
          const header = document.createElement('div');
          header.className = 'category-header';
          header.innerHTML = `<span>${cat}</span><span class="category-arrow">â–¶</span>`;
          block.appendChild(header);
          // åˆ†é¡å…§å®¹
          const content = document.createElement('div');
          content.className = 'category-content';
          content.style.display = 'none'; // é è¨­å…¨éƒ¨æ”¶åˆ
          
          categories[cat].forEach(data => {
            const limitInfo = data.orderLimit > 0 ? 
                            `<span style="color:#f39c12;font-size:0.9em;margin-left:8px;">é™é» ${data.orderLimit} ä»½</span>` : '';
            
            const div = document.createElement('div');
            div.className = 'menu-item';
            
            div.innerHTML = `
              <span>
                ${data.image ? 
                  `<img src="${data.image}" alt="${data.name}" class="clickable-image" onclick="openImageModal('${data.image}', '${data.name}')" onerror="this.outerHTML='<div style=&quot;width:48px;height:48px;background:#e0b873;color:#2d2320;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;margin-right:12px;border:2px solid #e0b87355;&quot;>ğŸ½ï¸</div>';" />` : 
                  `<div style="width:48px;height:48px;background:#e0b873;color:#2d2320;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;margin-right:12px;border:2px solid #e0b87355;">ğŸ½ï¸</div>`
                }
                <span class="info">
                  <div>${data.name}${data.isHot ? '<span class="hot-badge">HOT</span>' : ''}${limitInfo}</div>
                  <div class="price">$${data.price || ''}</div>
                  <div class="note">${data.note ? data.note : ''}</div>
                </span>
              </span>
              <input type="number" id="item_${data.id}" min="0" value="0" max="${data.orderLimit > 0 ? data.orderLimit : ''}" oninput="checkOrderLimit(this, '${data.name}', ${data.orderLimit})" onchange="checkOrderLimit(this, '${data.name}', ${data.orderLimit})" />
            `;
            content.appendChild(div);
          });
          
          block.appendChild(content);
          // é»æ“Šå±•é–‹/æ”¶åˆ
          header.onclick = function() {
            const isOpen = content.style.display === 'block';
            content.style.display = isOpen ? 'none' : 'block';
            header.querySelector('.category-arrow').classList.toggle('open', !isOpen);
          };
          menuList.appendChild(block);
        });
        
        if (menu.length === 0) menuList.innerHTML = '<div>ç›®å‰ç„¡å¯é»é¤é»</div>';
      } catch (e) {
        console.error("è¼‰å…¥èœå–®å¤±æ•—:", e);
        menuList.innerHTML = '<div>èœå–®è¼‰å…¥å¤±æ•—</div>';
      }
    }

    // é€å‡ºè¨‚å–®ï¼ˆé¡¯ç¤ºç¢ºèªmodalï¼‰
    async function submitOrder() {
      const dineType = document.getElementById('dineType').value;
      const tableNumber = document.getElementById('tableNumber').value.trim();
      
      if (!dineType) {
        showToast("è«‹é¸æ“‡å¤–å¸¶æˆ–å…§ç”¨ï¼");
        return;
      }

      // é©—è­‰æ¡Œè™Ÿé‚è¼¯
      if (dineType === 'å…§ç”¨' && !tableNumber) {
        showToast("å…§ç”¨è«‹è¼¸å…¥æ¡Œè™Ÿï¼");
        return;
      }

      const items = [];
      let totalAmount = 0;
      const limitErrors = [];
      
      menu.forEach(item => {
        // æª¢æŸ¥ä¸€èˆ¬åˆ†é¡ä¸­çš„æ•¸é‡
        const normalQty = parseInt(document.getElementById('item_' + item.id)?.value || "0");
        // æª¢æŸ¥ç†±éŠ·å€å¡Šä¸­çš„æ•¸é‡
        const hotQty = parseInt(document.getElementById('hot_item_' + item.id)?.value || "0");
        // ç¸½æ•¸é‡æ˜¯å…©è€…ç›¸åŠ 
        const totalQty = normalQty + hotQty;
        
        if (totalQty > 0) {
          // æª¢æŸ¥å–®æ¬¡é»é¤é™åˆ¶
          const orderLimit = menuOrderLimits[item.name] || 0;
          
          if (orderLimit > 0 && totalQty > orderLimit) {
            limitErrors.push(`${item.name} æ¯äººé™é» ${orderLimit} ä»½ï¼Œæ‚¨é¸æ“‡äº† ${totalQty} ä»½`);
            return;
          }
          
          const price = menuPrices[item.name] || 0;
          items.push({ 
            name: item.name, 
            quantity: totalQty, 
            price: price,
            subtotal: price * totalQty
          });
          totalAmount += price * totalQty;
        }
      });

      if (limitErrors.length > 0) {
        showToast(limitErrors[0]);
        return;
      }

      if (items.length === 0) {
        showToast("è«‹é¸æ“‡é¤é»ï¼");
        return;
      }

      // æº–å‚™è¨‚å–®è³‡æ–™
      const orderId = await generateOrderId(dineType);
      const orderData = {
        orderId: orderId,
        tableNumber: dineType === 'å…§ç”¨' ? tableNumber : '',
        dineType: dineType,
        items: items,
        totalAmount: totalAmount,
        status: "pending"
      };

      if (dineType === 'å¤–å¸¶') {
        // å¾è¨‚å–®ç·¨è™Ÿä¸­æå–å–é¤è™Ÿç¢¼ï¼Œä¾‹å¦‚ 20250706-T001 â†’ 001
        const match = orderId.match(/-T(\d{3})$/);
        orderData.takeoutNumber = match ? match[1] : '001';
      }

      currentOrderData = orderData;
      showOrderConfirmModal(orderData);
    }

    // é¡¯ç¤ºè¨‚å–®ç¢ºèªmodal
    function showOrderConfirmModal(orderData) {
      const modal = document.getElementById('confirmModal');
      const orderDetails = document.getElementById('orderDetails');
      const totalAmount = document.getElementById('totalAmount');
      
      let tableInfo = '';
      if (orderData.dineType === 'å…§ç”¨') {
        tableInfo = `<p><strong>æ¡Œè™Ÿï¼š</strong>${orderData.tableNumber}</p>`;
      } else {
        tableInfo = `<p><strong>å–é¤è™Ÿç¢¼ï¼š</strong>${orderData.takeoutNumber}</p>`;
      }
      
      orderDetails.innerHTML = `
        <p><strong>ç”¨é¤æ–¹å¼ï¼š</strong>${orderData.dineType}</p>
        ${tableInfo}
        <p><strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>${orderData.orderId}</p>
        <table class="order-table">
          <thead>
            <tr>
              <th>é¤é»</th>
              <th>æ•¸é‡</th>
              <th>å–®åƒ¹</th>
              <th>å°è¨ˆ</th>
            </tr>
          </thead>
          <tbody>
            ${orderData.items.map(item => `
              <tr>
                <td>${item.name}</td>
                <td>${item.quantity}</td>
                <td>$${item.price}</td>
                <td>$${item.subtotal}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      totalAmount.innerHTML = `ç¸½é‡‘é¡ï¼š$${orderData.totalAmount}`;
      modal.style.display = 'block';
    }

    // é—œé–‰modal
    function closeModal() {
      document.getElementById('confirmModal').style.display = 'none';
    }

    // ç¢ºèªè¨‚å–®
    async function confirmOrder() {
      if (!currentOrderData) return;
      
      const btn = document.querySelector('.btn-confirm');
      btn.disabled = true;
      btn.innerText = 'é€å‡ºä¸­...';

      try {
        await apiRequest('/orders', {
          method: 'POST',
          body: JSON.stringify(currentOrderData)
        });
        
        closeModal();
        showToast(`è¨‚å–®å·²é€å‡ºï¼${currentOrderData.dineType === 'å¤–å¸¶' ? 'å–é¤è™Ÿç¢¼ï¼š' + currentOrderData.takeoutNumber : ''}`);
        setTimeout(() => location.reload(), 1200);
      } catch (e) {
        console.error("é€å‡ºè¨‚å–®å¤±æ•—:", e);
        showToast("é€å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦");
        btn.disabled = false;
        btn.innerText = 'ç¢ºèªé€å‡º';
      }
    }

    // åˆ‡æ›å…§ç”¨/å¤–å¸¶æŒ‰éˆ•
    window.selectDineType = function(type) {
      document.getElementById('dineType').value = type;
      document.getElementById('dineInBtn').classList.toggle('selected', type === 'å…§ç”¨');
      document.getElementById('takeOutBtn').classList.toggle('selected', type === 'å¤–å¸¶');
      
      // æ§åˆ¶æ¡Œè™Ÿæ¬„ä½é¡¯ç¤º
      const tableSection = document.getElementById('tableSection');
      if (type === 'å¤–å¸¶') {
        tableSection.classList.add('hidden');
        document.getElementById('tableNumber').value = '';
      } else {
        tableSection.classList.remove('hidden');
      }
    }

    // åœ–ç‰‡æ”¾å¤§åŠŸèƒ½
    function openImageModal(imageSrc, altText) {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('modalImage');
      modal.style.display = 'block';
      modalImg.src = imageSrc;
      modalImg.alt = altText;
    }

    function closeImageModal() {
      document.getElementById('imageModal').style.display = 'none';
    }

    // å…¨åŸŸå‡½æ•¸
    window.submitOrder = submitOrder;
    window.closeModal = closeModal;
    window.confirmOrder = confirmOrder;
    window.openImageModal = openImageModal;
    window.closeImageModal = closeImageModal;
    window.checkOrderLimit = checkOrderLimit;

    // åˆå§‹åŒ–
    window.onload = async function() {
      document.getElementById('tableNumber').value = getTableNumberFromQuery();
      await loadMenu();
    }

    // é»æ“Šmodalå¤–éƒ¨é—œé–‰
    window.onclick = function(event) {
      const confirmModal = document.getElementById('confirmModal');
      const imageModal = document.getElementById('imageModal');
      
      if (event.target === confirmModal) {
        closeModal();
      }
      if (event.target === imageModal) {
        closeImageModal();
      }
    }
  </script>
</body>
</html> 